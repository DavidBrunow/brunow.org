{"schemaVersion":{"major":0,"minor":3,"patch":0},"metadata":{"title":"Snapshot Testing with Xcode Cloud","color":{"standardColorIdentifier":"purple"},"images":[{"identifier":"snapshotTestFailures.png","type":"card"}],"platforms":[{"name":"Brunow","introducedAt":"2023.08.30"}],"modules":[{"name":"Brunow"}]},"primaryContentSections":[{"kind":"content","content":[{"text":"Backstory","type":"heading","level":2,"anchor":"Backstory"},{"style":"tip","name":"Tip","content":[{"inlineContent":[{"text":"If you don‚Äôt want to read about the backstory and just want to get your","type":"text"},{"text":" ","type":"text"},{"text":"snapshot tests working on Xcode Cloud then you might want to skip to the","type":"text"},{"text":" ","type":"text"},{"type":"reference","isActive":true,"identifier":"#Getting-Snapshot-Tests-Working-on-Xcode-Cloud"},{"text":".","type":"text"}],"type":"paragraph"}],"type":"aside"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Over the last several weeks I‚Äôve been working on a side project app as a way to"},{"type":"text","text":" "},{"type":"text","text":"flex some product development muscles, build an entire app in the"},{"type":"text","text":" "},{"type":"reference","isActive":true,"identifier":"https:\/\/github.com\/pointfreeco\/swift-composable-architecture"},{"type":"text","text":","},{"type":"text","text":" "},{"type":"text","text":"and experiment with tools and processes that I don‚Äôt"},{"type":"text","text":" "},{"type":"text","text":"get to use in my day job. I‚Äôve tried to be very intentional about adding complexity to"},{"type":"text","text":" "},{"type":"text","text":"the project and therefore"},{"type":"text","text":" "},{"type":"text","text":"started off simply by not worrying about modularity or organization and instead"},{"text":" ","type":"text"},{"type":"text","text":"just putting all of my Swift files into a single Xcode project and letting the"},{"type":"text","text":" "},{"type":"text","text":"flow of creation take me where it would. To keep CI\/CD simple I decided to use"},{"text":" ","type":"text"},{"text":"Xcode Cloud and created a pipeline that would deploy a build to TestFlight every","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"time I merged to "},{"code":"main","type":"codeVoice"},{"type":"text","text":". My simple process was to write a bit of code each day,"},{"text":" ","type":"text"},{"text":"commit it to ","type":"text"},{"type":"codeVoice","code":"main"},{"text":", and then use the TestFlight build to get a feel for what","type":"text"},{"text":" ","type":"text"},{"text":"needed to be done next.","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"Last week I shipped my first bug that caused a regression in functionality","type":"text"},{"text":" ","type":"text"},{"text":"and decided that I‚Äôd gotten to the point of complexity where I","type":"text"},{"type":"text","text":" "},{"type":"text","text":"needed some automated tests. I hadn‚Äôt been writing any tests to that point"},{"text":" ","type":"text"},{"text":"because what I‚Äôd built was not complex and because I was still in a highly","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"experimental phase where tests would probably slow down the flow. But I think I"},{"type":"text","text":" "},{"text":"hit the tipping point where adding those tests would speed things up by limiting","type":"text"},{"type":"text","text":" "},{"type":"text","text":"potential backsliding from regressions."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Before I started writing tests I chose to do some "},{"type":"reference","identifier":"http:\/\/projects.csail.mit.edu\/gsb\/old-archive\/gsb-archive\/gsb2000-02-11.html","isActive":true},{"type":"text","text":" "},{"type":"text","text":"so I could implement the module hierarchy that I wanted. Modularizing would allow"},{"text":" ","type":"text"},{"text":"me to write tests targeted at specific features which I could build and run in","type":"text"},{"type":"text","text":" "},{"type":"text","text":"isolation as my app grows. So I shaved these yaks to modularize my app using"},{"text":" ","type":"text"},{"type":"text","text":"Swift Package Manager:"}]},{"items":[{"content":[{"inlineContent":[{"type":"text","text":"Created a Package.swift file"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Defined all my modules and their dependencies in that file"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Copied my code to the proper locations for Swift Package Manager"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Added that Package.swift to my project"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Made API public until the app would successfully build again"}]}]}],"type":"unorderedList"},{"inlineContent":[{"text":"This is a process I am very familiar with but it still took me some time and I","type":"text"},{"type":"text","text":" "},{"text":"had to be patient with myself while doing it. Part of my mind was wanting me to","type":"text"},{"type":"text","text":" "},{"text":"hurry up and get back to building things because that part of my mind does not","type":"text"},{"type":"text","text":" "},{"text":"like to acknowledge that organizing and tidying up is part of the building","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"process."}],"type":"paragraph"},{"inlineContent":[{"text":"OK so I had modules and now I was ready to add tests. As I mentioned earlier,","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"I‚Äôm using the Composable Architecture"},{"type":"text","text":" "},{"type":"text","text":"for this app and since I‚Äôm familiar with using it from the day job I only had to"},{"text":" ","type":"text"},{"type":"text","text":"do minor refactoring around how I was generating UUIDs to support tests. I"},{"text":" ","type":"text"},{"text":"started with a test around the regression that I‚Äôd found and used the test to","type":"text"},{"text":" ","type":"text"},{"text":"troubleshoot the issue. Once that was resolved I finished out tests around the","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"rest of the features in the app."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"One of my modules is a ‚ÄúDesignSystem‚Äù module which has UI components with little"},{"text":" ","type":"text"},{"type":"text","text":"to no logic in them. Despite the lack of logic I still like to get some coverage"},{"type":"text","text":" "},{"type":"text","text":"on their layout and how they behave in different environments (like light mode,"},{"text":" ","type":"text"},{"text":"dark mode, and different Dynamic Type sizes) so I added some snapshot tests for","type":"text"},{"type":"text","text":" "},{"type":"text","text":"that using "},{"type":"reference","isActive":true,"identifier":"https:\/\/github.com\/pointfreeco\/swift-snapshot-testing"},{"text":".","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"I ran all my tests locally and everything passed. üéâ"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Now to get them running on Xcode Cloud. My experience with Xcode Cloud to this"},{"text":" ","type":"text"},{"text":"point had been simple and easy so I expected the same with adding tests. But my","type":"text"},{"type":"text","text":" "},{"type":"text","text":"decision earlier to modularize meant that I needed to shave another yak or two"},{"text":" ","type":"text"},{"text":"‚Äî Xcode Cloud wants a specific test target or a test plan to run tests","type":"text"},{"text":" ","type":"text"},{"text":"against and after modularizing I have multiple test targets. So I added a test","type":"text"},{"text":" ","type":"text"},{"text":"plan I named ‚ÄúAllTests‚Äù and included all the test targets in it. This was","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"oddly difficult because apparently there already was a test plan in the project"},{"type":"text","text":" "},{"text":"that was automatically generated and I had to delete that one and jump through","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"some other hoops. Eventually I had a test plan that I could use both locally and"},{"text":" ","type":"text"},{"type":"text","text":"with my Xcode Cloud tests. I merged the changes to "},{"type":"codeVoice","code":"main"},{"type":"text","text":" and waited to see the"},{"type":"text","text":" "},{"type":"text","text":"green checkmark in Xcode Cloud."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"All my snapshot tests failed on Xcode Cloud. üòø"}]},{"anchor":"Figuring-Out-What-Was-Going-Wrong","text":"Figuring Out What Was Going Wrong","type":"heading","level":2},{"type":"paragraph","inlineContent":[{"type":"text","text":"My tests were failing and I didn‚Äôt know why so I went searching the internet for"},{"type":"text","text":" "},{"text":"clues, starting with the issues section of the Swift Snapshot Testing GitHub repo. I","type":"text"},{"type":"text","text":" "},{"type":"text","text":"found "},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/pointfreeco\/swift-snapshot-testing\/discussions\/553"},{"type":"text","text":" "},{"text":"which described what I was seeing and had a lot of discussion including multiple","type":"text"},{"type":"text","text":" "},{"text":"people who had resolved the issue. So I started na√Øvely implementing things that","type":"text"},{"type":"text","text":" "},{"type":"text","text":"were suggested in that thread without understanding the fundamentals of the"},{"text":" ","type":"text"},{"text":"problem. And those things I tried did not work ‚Äî I needed to learn a bit","type":"text"},{"type":"text","text":" "},{"text":"more about how Xcode Cloud works to be able to understand the conversations on","type":"text"},{"text":" ","type":"text"},{"text":"that issue.","type":"text"}]},{"name":"Note","content":[{"inlineContent":[{"type":"text","text":"While I had to do extra research to figure out what was going on I‚Äôd like to"},{"text":" ","type":"text"},{"type":"text","text":"give all the credit for this approach to the folks on that GitHub issue,"},{"type":"text","text":" "},{"text":"specifically Cameron Cooke and Oliver Foggin.","type":"text"}],"type":"paragraph"}],"style":"note","type":"aside"},{"type":"paragraph","inlineContent":[{"text":"Since the approach I wanted to take mentioned adding a ","type":"text"},{"code":"ci_scripts","type":"codeVoice"},{"type":"text","text":" folder I"},{"type":"text","text":" "},{"text":"searched for documentation around that and found ","type":"text"},{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Create-the-CI-scripts-directory"},{"type":"text","text":"."},{"text":" ","type":"text"},{"type":"text","text":"I didn‚Äôt care about custom build scripts but this documentation discussed where"},{"type":"text","text":" "},{"text":"the ","type":"text"},{"code":"ci_scripts","type":"codeVoice"},{"text":" folder needed to live, how to create it, and ","type":"text"},{"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Add-resources-to-the-CI-scripts-directory","isActive":true},{"text":".","type":"text"},{"type":"text","text":" "},{"type":"text","text":"That documentation gave me the underlying context I needed to fill in the"},{"text":" ","type":"text"},{"text":"details I was missing from the GitHub issue.","type":"text"}]},{"text":"Getting Snapshot Tests Working on Xcode Cloud","anchor":"Getting-Snapshot-Tests-Working-on-Xcode-Cloud","level":2,"type":"heading"},{"style":"note","type":"aside","name":"Note","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Some of this configuration to get snapshot tests working on Xcode Cloud is"},{"text":" ","type":"text"},{"type":"text","text":"very specific to the way the project is setup. I‚Äôll try to call out those"},{"text":" ","type":"text"},{"type":"text","text":"specific places but if your project is setup differently than mine then"},{"type":"text","text":" "},{"text":"this may not work.","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"Also, two different approaches were discussed in the GitHub issue that I","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"linked above but I believe the approach that I‚Äôll go through here is more"},{"type":"text","text":" "},{"type":"text","text":"straightforward and maintainable."}]}]},{"inlineContent":[{"text":"At a high level, this is what we need to do:","type":"text"}],"type":"paragraph"},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"text":"Create a ","type":"text"},{"type":"codeVoice","code":"ci_scripts"},{"type":"text","text":" directory where Xcode Cloud expects it to be."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Create a symlink in the "},{"code":"ci_scripts","type":"codeVoice"},{"type":"text","text":" directory to where our snapshots are stored."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Detect when running on Xcode Cloud in our snapshot tests."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Provide Swift Snapshot Testing with a file path to the ","type":"text"},{"code":"ci_scripts","type":"codeVoice"},{"type":"text","text":" directory when running on Xcode Cloud."}]}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Let‚Äôs walk through those steps in detail."}]},{"type":"heading","text":"Create a ci_scripts directory where Xcode Cloud expects it to be","level":3,"anchor":"Create-a-ciscripts-directory-where-Xcode-Cloud-expects-it-to-be"},{"type":"paragraph","inlineContent":[{"text":"Copied from ","type":"text"},{"isActive":true,"overridingTitle":"Apple‚Äôs documentation","overridingTitleInlineContent":[{"text":"Apple‚Äôs documentation","type":"text"}],"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Create-the-CI-scripts-directory"},{"type":"text","text":":"}]},{"inlineContent":[{"text":"To create the ","type":"text"},{"code":"ci_scripts","type":"codeVoice"},{"type":"text","text":" directory:"}],"type":"paragraph"},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Open your project or workspace in Xcode and navigate to the Project navigator.","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"In the Project navigator, Control-click your project and choose New Group to create the group and its corresponding directory.","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Name the new group ci_scripts.","type":"text"}],"type":"paragraph"}]}]},{"type":"heading","anchor":"Create-a-symlink-in-the-ciscripts-directory-to-where-our-snapshots-are-stored","level":3,"text":"Create a symlink in the ci_scripts directory to where our snapshots are stored"},{"name":"Note","type":"aside","content":[{"inlineContent":[{"text":"The way this symlink is created is specific to the directory structure.","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"Hopefully I‚Äôm providing enough detail here for you to make any adjustments you"},{"type":"text","text":" "},{"text":"need for your project.","type":"text"}],"type":"paragraph"}],"style":"note"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Here is the directory structure that I‚Äôm using:"}]},{"code":["SpeakList\/","  .git\/","  App\/","    SpeakList.xcodeproj\/","    ci_scripts","    ...","  Sources\/","    ...","  Tests\/","    SnapshotTests\/","      SnapshotTests.swift","      __Snapshots__\/","    ...","  ..."],"syntax":"shell","type":"codeListing"},{"inlineContent":[{"type":"text","text":"The root directory is called ‚ÄúSpeakList‚Äù, the Xcode project is in a directory"},{"text":" ","type":"text"},{"type":"text","text":"called ‚ÄúApp‚Äù which also contains the ‚Äúci_scripts‚Äù directory, and there are"},{"text":" ","type":"text"},{"type":"text","text":"‚ÄúSources‚Äù and ‚ÄúTests‚Äù directories to follow the default directory structure that"},{"type":"text","text":" "},{"text":"Swift Package Manager expects. The ‚ÄúTests‚Äù directory has a ‚ÄúSnapshotTests‚Äù","type":"text"},{"text":" ","type":"text"},{"text":"directory with the test file ‚ÄúSnapshotTests.swift‚Äù and the ‚Äú","type":"text"},{"type":"codeVoice","code":"__Snapshots__"},{"type":"text","text":"‚Äù"},{"text":" ","type":"text"},{"type":"text","text":"folder where Swift Snapshot Testing stores the snapshots."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"We need a symlink from the ","type":"text"},{"code":"SpeakList\/App\/ci_scripts","type":"codeVoice"},{"type":"text","text":" directory to the"},{"text":" ","type":"text"},{"type":"codeVoice","code":"SpeakList\/Tests\/SnapshotTests\/__Snapshots__"},{"type":"text","text":" directory which we can create by"},{"text":" ","type":"text"},{"type":"text","text":"running this command in the "},{"code":"ci_scripts","type":"codeVoice"},{"text":" directory:","type":"text"}]},{"type":"codeListing","code":["ln -s ..\/..\/Tests\/SnapshotTests\/__Snapshots__"],"syntax":"shell"},{"type":"aside","name":"Note","style":"note","content":[{"type":"paragraph","inlineContent":[{"text":"This setup assumes that you only have one target in which you are running","type":"text"},{"type":"text","text":" "},{"type":"text","text":"snapshot tests and therefore only one "},{"code":"__Snapshots__","type":"codeVoice"},{"text":" directory.","type":"text"}]}]},{"type":"heading","level":3,"text":"Detect When Running on Xcode Cloud in our Snapshot Tests","anchor":"Detect-When-Running-on-Xcode-Cloud-in-our-Snapshot-Tests"},{"type":"paragraph","inlineContent":[{"type":"text","text":"This is the part that tripped me up the most while I was trying to make this"},{"type":"text","text":" "},{"type":"text","text":"work. There are different ways that you could achieve the same goal of"},{"type":"text","text":" "},{"type":"text","text":"determining that the tests are running on Xcode Cloud but I chose to use the"},{"type":"text","text":" "},{"type":"codeVoice","code":"CI"},{"text":" environment variable that Xcode Cloud injects.","type":"text"}]},{"level":4,"text":"Pipe the Environment Variable into the Test Plan","type":"heading","anchor":"Pipe-the-Environment-Variable-into-the-Test-Plan"},{"type":"paragraph","inlineContent":[{"text":"For our tests to get access to this environment variable we have to ‚Äúpipe‚Äù the","type":"text"},{"type":"text","text":" "},{"type":"text","text":"variable through our Test Plan. I‚Äôd never done this before and Test Plans are a"},{"text":" ","type":"text"},{"type":"text","text":"newer Xcode feature so I found it difficult to find documentation on what is"},{"text":" ","type":"text"},{"type":"text","text":"needed. I eventually found "},{"isActive":true,"type":"reference","identifier":"https:\/\/docs.datadoghq.com\/continuous_integration\/tests\/swift\/?tab=swiftpackagemanager#configuring-datadog"},{"text":" ","type":"text"},{"text":"with this nugget that set me right:","type":"text"}]},{"style":"note","name":"Quote","content":[{"type":"paragraph","inlineContent":[{"text":"You ","type":"text"},{"inlineContent":[{"type":"text","text":"must"}],"type":"strong"},{"text":" select your main target in Expand variables based on or Target for Variable Expansion if you are using test plans","type":"text"}]}],"type":"aside"},{"inlineContent":[{"type":"text","text":"To pipe the environment variable through we need to edit our TestPlan so it"},{"text":" ","type":"text"},{"type":"text","text":"looks like this:"}],"type":"paragraph"},{"inlineContent":[{"type":"image","identifier":"testPlanConfiguration"}],"type":"paragraph"},{"inlineContent":[{"text":"‚ÄúEnvironment Variables‚Äù is set to ","type":"text"},{"type":"codeVoice","code":"CI=$(CI)"},{"type":"text","text":" and ‚ÄúTarget for Variable Expansion‚Äù"},{"type":"text","text":" "},{"type":"text","text":"is set to ‚ÄúSpeakList‚Äù which is the main app target."}],"type":"paragraph"},{"type":"heading","anchor":"Access-the-Environment-Variable-in-Tests","level":4,"text":"Access the Environment Variable in Tests"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Now that we‚Äôve piped the variable through we use "},{"type":"codeVoice","code":"ProcessInfo"},{"text":" to access the","type":"text"},{"type":"text","text":" "},{"type":"text","text":"variable in our tests. Here is what the single line of code looks like to return"},{"type":"text","text":" "},{"type":"text","text":"a Boolean for whether we are in the CI environment (we know we want to test"},{"text":" ","type":"text"},{"type":"text","text":"for the value of "},{"type":"codeVoice","code":"\"TRUE\""},{"type":"text","text":" based upon the "},{"type":"reference","isActive":true,"identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/environment-variable-reference#Variables-that-are-always-available"},{"type":"text","text":"):"}]},{"code":["ProcessInfo.processInfo.environment[\"CI\"] == \"TRUE\""],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"I‚Äôll share how that fits in with the rest of our test code in a bit.","type":"text"}]},{"type":"heading","text":"Provide Swift Snapshot Testing with a File Path to the ci_scripts Directory when Running on Xcode Cloud","level":3,"anchor":"Provide-Swift-Snapshot-Testing-with-a-File-Path-to-the-ciscripts-Directory-when-Running-on-Xcode-Cloud"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Swift Snapshot Testing uses the location of the file where the tests are being"},{"type":"text","text":" "},{"type":"text","text":"run to determine where it creates and looks for snapshots. When running in Xcode"},{"text":" ","type":"text"},{"text":"Cloud we need to provide a different file path to the ","type":"text"},{"type":"codeVoice","code":"assertSnapshot"},{"text":" method so","type":"text"},{"type":"text","text":" "},{"text":"Swift Snapshot Testing can find the snapshots in the location we symlinked them","type":"text"},{"type":"text","text":" "},{"type":"text","text":"in the second step."}]},{"type":"paragraph","inlineContent":[{"text":"First we need to create a ","type":"text"},{"type":"codeVoice","code":"StaticString"},{"type":"text","text":":"}]},{"type":"codeListing","syntax":"swift","code":["let xcodeCloudPath: StaticString = \"\/Volumes\/workspace\/repository\/ci_scripts\/DesignSystemTests.swift\""]},{"inlineContent":[{"text":"Then we need to choose to use that ","type":"text"},{"code":"StaticString","type":"codeVoice"},{"type":"text","text":" when running on CI:"}],"type":"paragraph"},{"type":"codeListing","code":["let filePath: StaticString","","if ProcessInfo.processInfo.environment[\"CI\"] == \"TRUE\" {","  filePath = xcodeCloudPath","} else {","  filePath = #file","}"],"syntax":"swift"},{"inlineContent":[{"text":"And then we need to provide the correct file path to the ","type":"text"},{"code":"assertSnapshot","type":"codeVoice"},{"text":" method:","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["assertSnapshot(","  matching: view,","  as: .image,","  file: filePath",")"],"type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"After putting that all together our snapshot test could look like this:"}]},{"code":["class SnapshotTests: XCTestCase {","  let xcodeCloudPath: StaticString = \"\/Volumes\/workspace\/repository\/ci_scripts\/SnapshotTests.swift\"","","  func testTextExampleSnapshot() {","    let view = Text(\"Snapshot Test Example\")","      .frame(width: 200, height: 200)","","    let filePath: StaticString","","    if ProcessInfo.processInfo.environment[\"CI\"] == \"TRUE\" {","      filePath = xcodeCloudPath","    } else {","      filePath = #file","    }","","    assertSnapshot(","      matching: view,","      as: .image,","      file: filePath","    )","  }","}"],"type":"codeListing","syntax":"swift"},{"level":2,"type":"heading","text":"Creating Something Reusable","anchor":"Creating-Something-Reusable"},{"inlineContent":[{"text":"That code we just created gets the job done but that boilerplate code to","type":"text"},{"text":" ","type":"text"},{"text":"test for running on CI in every test would get annoying to write over and over.","type":"text"},{"text":" ","type":"text"},{"text":"It would be better to extract the common things we want to do for every snapshot","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"test to a separate method to remove that redundancy and have consistent"},{"type":"text","text":" "},{"type":"text","text":"snapshot tests for all of our views."}],"type":"paragraph"},{"inlineContent":[{"text":"I‚Äôve created an extension on ","type":"text"},{"type":"codeVoice","code":"XCTest"},{"type":"text","text":" with a method that handles the check for"},{"type":"text","text":" "},{"text":"running on CI as well as:","type":"text"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Checks that the device or simulator used for creating snapshots has a"},{"text":" ","type":"text"},{"type":"text","text":"consistent display scale and OS version"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Creates snapshots inside a view controller so we are capturing what the view","type":"text"},{"type":"text","text":" "},{"type":"text","text":"will look like on device"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Creates snapshots in all color schemes (Light Mode and Dark Mode)"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Creates snapshots in all Dynamic Type sizes"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Disables animations in the view to get more consistent snapshots"}]}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Here is that extension:"}]},{"type":"codeListing","code":["import SnapshotTesting","import SwiftUI","import XCTest","","extension XCTest {","  \/\/ https:\/\/github.com\/pointfreeco\/swift-snapshot-testing\/discussions\/553#discussioncomment-3807207","  private static var xcodeCloudFilePath: StaticString {","    \"\/Volumes\/workspace\/repository\/ci_scripts\/SnapshotTests.swift\"","  }","  private static var isCIEnvironment: Bool {","    ProcessInfo.processInfo.environment[\"CI\"] == \"TRUE\"","  }","","  \/\/\/ Creates snapshots in a variety of different environments at the screen size of an iPhone 13 Pro (by default).","  \/\/\/ This method must be called when running tests on a device or simulator with the proper display scale","  \/\/\/ and OS version.","  \/\/\/","  \/\/\/ Environments used for these snapshots:","  \/\/\/ * Light Mode","  \/\/\/ * Dark Mode","  \/\/\/ * All Dynamic Type Sizes","  \/\/\/","  \/\/\/ - Parameters:","  \/\/\/   - view: The SwiftUI `View` to snapshot.","  \/\/\/   - snapshotDeviceOSVersions: A dictionary of the OS versions used for snapshots. Defaults","  \/\/\/   to: [\"iOS\": 17.0, \"macOS\": 14.0, \"tvOS\": 17.0, \"visionOS\": 1.0, \"watchOS\": 10.0]. The test will fail","  \/\/\/   if snapshots are recorded with a different version.","  \/\/\/   - snapshotDeviceScale: The device scale used when recorded snapshots. Defaults to 3.0.","  \/\/\/   The test will fail if snapshots are recorded with a different scale.","  \/\/\/   - viewImageConfig: The `ViewImageConfig` for the snapshot. Defaults to `.iPhone13Pro`.","  \/\/\/   - xcodeCloudFilePath: A `StaticString` describing the path that will be used when","  \/\/\/   running these tests on Xcode Cloud. Defaults to `\"\/Volumes\/workspace\/repository\/ci_scripts\/SnapshotTests.swift\"`. If your","  \/\/\/   tests are in a Swift file with a name other than \"SnapshotTests.swift\" you will need to provide this","  \/\/\/   same `StaticString` but with your test file's name in place of \"SnapshotTests.swift\".","  \/\/\/   - file: The file in which failure occurred. Defaults to the file name of the test case in which this function was called.","  \/\/\/   - testName: The name of the test in which failure occurred. Defaults to the function name of the test case in which this function was called.","  \/\/\/   - line: The line number on which failure occurred. Defaults to the line number on which this function was called.","  func assertStandardSnapshots(","    view: some View,","    snapshotDeviceOSVersions: [String: Double] = [","      \"iOS\": 17.0,","      \"macOS\": 14.0,","      \"tvOS\": 17.0,","      \"visionOS\": 1.0,","      \"watchOS\": 10.0","    ],","    snapshotDeviceScale: CGFloat = 3,","    viewImageConfig: ViewImageConfig = .iPhone13Pro,","    xcodeCloudFilePath: StaticString = xcodeCloudFilePath,","    file: StaticString = #file,","    testName: String = #function,","    line: UInt = #line","  ) {","    guard UIScreen.main.scale == snapshotDeviceScale else {","      XCTFail(","        \"Running in simulator with @\\(UIScreen.main.scale)x scale instead of the required @\\(snapshotDeviceScale)x scale.\",","        file: file,","        line: line","      )","      return","    }","    let snapshotDeviceOSVersion: String","    #if os(iOS)","    guard let version = snapshotDeviceOSVersions[\"iOS\"] else {","      XCTFail(","        \"iOS version not provided.\",","        file: file,","        line: line","      )","      return","    }","    snapshotDeviceOSVersion = \"\\(version)\"","    #elseif os(macOS)","    guard let version = snapshotDeviceOSVersions[\"macOS\"] else {","      XCTFail(","        \"macOS version not provided.\",","        file: file,","        line: line","      )","      return","    }","    snapshotDeviceOSVersion = \"\\(version)\"","    #elseif os(tvOS)","    guard let version = snapshotDeviceOSVersions[\"tvOS\"] else {","      XCTFail(","        \"tvOS version not provided.\",","        file: file,","        line: line","      )","      return","    }","    snapshotDeviceOSVersion = \"\\(version)\"","    #elseif os(visionOS)","    guard let version = snapshotDeviceOSVersions[\"visionOS\"] else {","      XCTFail(","        \"visionOS version not provided.\",","        file: file,","        line: line","      )","      return","    }","    snapshotDeviceOSVersion = \"\\(version)\"","    #elseif os(watchOS)","    guard let version = snapshotDeviceOSVersions[\"watchOS\"] else {","      XCTFail(","        \"watchOS version not provided.\",","        file: file,","        line: line","      )","      return","    }","    snapshotDeviceOSVersion = \"\\(version)\"","    #endif","    guard UIDevice.current.systemVersion == \"\\(snapshotDeviceOSVersion)\" else {","      XCTFail(","        \"Running with OS version \\(UIDevice.current.systemVersion) instead of the required OS version \\(snapshotDeviceOSVersion).\",","        file: file,","        line: line","      )","      return","    }","","    let filePath: StaticString","","    if Self.isCIEnvironment {","      filePath = xcodeCloudFilePath","    } else {","      filePath = file","    }","","    for colorScheme in ColorScheme.allCases {","      let viewController = UIHostingController(","        rootView: view","          .transaction {","            $0.animation = nil","          }","          .background(colorScheme == .light ? Color.white : Color.black)","          .environment(\\.colorScheme, colorScheme)","      )","      viewController.view.backgroundColor = colorScheme == .light ? .white : .black","","      assertSnapshot(","        matching: viewController,","        as: .image(on: viewImageConfig),","        named: \"\\(name) - Color Scheme: \\(colorScheme)\",","        file: filePath,","        testName: testName,","        line: line","      )","    }","","    for size in DynamicTypeSize.allCases {","      let viewController = UIHostingController(","        rootView: view","          .transaction {","            $0.animation = nil","          }","          .environment(\\.dynamicTypeSize, size)","      )","","      assertSnapshot(","        matching: viewController,","        as: .image(on: viewImageConfig),","        named: \"\\(name) - Dynamic Type: \\(size)\",","        file: filePath,","        testName: testName,","        line: line","      )","    }","  }","}"],"syntax":"swift"}]}],"kind":"article","identifier":{"interfaceLanguage":"swift","url":"doc:\/\/Brunow\/documentation\/Brunow\/08-30-snapshot-testing-with-xcode-cloud"},"topicSectionsStyle":"detailedGrid","abstract":[{"text":"Working around unexpectedly sharp edges when using snapshot tests.","type":"text"}],"sections":[],"variants":[{"paths":["\/documentation\/brunow\/08-30-snapshot-testing-with-xcode-cloud"],"traits":[{"interfaceLanguage":"swift"}]}],"hierarchy":{"paths":[["doc:\/\/Brunow\/documentation\/Brunow"],["doc:\/\/Brunow\/documentation\/Brunow","doc:\/\/Brunow\/documentation\/Brunow\/Archive","doc:\/\/Brunow\/documentation\/Brunow\/2023"]]},"references":{"https://developer.apple.com/documentation/xcode/writing-custom-build-scripts#Create-the-CI-scripts-directory":{"type":"link","url":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Create-the-CI-scripts-directory","titleInlineContent":[{"type":"text","text":"this documentation for writing"},{"type":"text","text":" "},{"type":"text","text":"custom build scripts on Xcode Cloud"}],"identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Create-the-CI-scripts-directory","title":"this documentation for writing custom build scripts on Xcode Cloud"},"doc://Brunow/documentation/Brunow":{"url":"\/documentation\/brunow","abstract":[{"type":"text","text":"David Brunow, known as Brunow [Ààb…πuno ä] to the folks he works with, is a human living on Earth. You might have something in common with him ‚Äî if you think it is ridiculous that he is talking about himself in the first person here, so does he."}],"kind":"symbol","role":"collection","title":"Brunow","type":"topic","identifier":"doc:\/\/Brunow\/documentation\/Brunow"},"https://github.com/pointfreeco/swift-composable-architecture":{"url":"https:\/\/github.com\/pointfreeco\/swift-composable-architecture","type":"link","title":"Composable Architecture","titleInlineContent":[{"type":"text","text":"Composable Architecture"}],"identifier":"https:\/\/github.com\/pointfreeco\/swift-composable-architecture"},"#Getting-Snapshot-Tests-Working-on-Xcode-Cloud":{"type":"link","url":"#Getting-Snapshot-Tests-Working-on-Xcode-Cloud","titleInlineContent":[{"type":"text","text":"section with the steps needed to get them working"}],"identifier":"#Getting-Snapshot-Tests-Working-on-Xcode-Cloud","title":"section with the steps needed to get them working"},"doc://Brunow/documentation/Brunow/Archive":{"kind":"article","type":"topic","abstract":[{"type":"text","text":"All posts"}],"title":"Archive","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/Archive","url":"\/documentation\/brunow\/archive","role":"collectionGroup"},"https://github.com/pointfreeco/swift-snapshot-testing":{"url":"https:\/\/github.com\/pointfreeco\/swift-snapshot-testing","type":"link","title":"Swift Snapshot Testing","titleInlineContent":[{"type":"text","text":"Swift Snapshot Testing"}],"identifier":"https:\/\/github.com\/pointfreeco\/swift-snapshot-testing"},"http://projects.csail.mit.edu/gsb/old-archive/gsb-archive/gsb2000-02-11.html":{"type":"link","url":"http:\/\/projects.csail.mit.edu\/gsb\/old-archive\/gsb-archive\/gsb2000-02-11.html","titleInlineContent":[{"type":"text","text":"yak shaving"}],"identifier":"http:\/\/projects.csail.mit.edu\/gsb\/old-archive\/gsb-archive\/gsb2000-02-11.html","title":"yak shaving"},"doc://Brunow/documentation/Brunow/2023":{"title":"2023","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/2023","url":"\/documentation\/brunow\/2023","role":"collectionGroup","abstract":[],"type":"topic","kind":"article"},"snapshotTestFailures.png":{"type":"image","variants":[{"url":"\/images\/snapshotTestFailures.png","traits":["1x","light"]}],"alt":null,"identifier":"snapshotTestFailures.png"},"https://developer.apple.com/documentation/xcode/writing-custom-build-scripts#Add-resources-to-the-CI-scripts-directory":{"identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Add-resources-to-the-CI-scripts-directory","url":"https:\/\/developer.apple.com\/documentation\/xcode\/writing-custom-build-scripts#Add-resources-to-the-CI-scripts-directory","titleInlineContent":[{"type":"text","text":"this section about"},{"type":"text","text":" "},{"type":"text","text":"resources in custom build scripts"}],"type":"link","title":"this section about resources in custom build scripts"},"https://github.com/pointfreeco/swift-snapshot-testing/discussions/553":{"type":"link","url":"https:\/\/github.com\/pointfreeco\/swift-snapshot-testing\/discussions\/553","titleInlineContent":[{"type":"text","text":"this issue"}],"identifier":"https:\/\/github.com\/pointfreeco\/swift-snapshot-testing\/discussions\/553","title":"this issue"},"https://docs.datadoghq.com/continuous_integration/tests/swift/?tab=swiftpackagemanager#configuring-datadog":{"identifier":"https:\/\/docs.datadoghq.com\/continuous_integration\/tests\/swift\/?tab=swiftpackagemanager#configuring-datadog","url":"https:\/\/docs.datadoghq.com\/continuous_integration\/tests\/swift\/?tab=swiftpackagemanager#configuring-datadog","titleInlineContent":[{"type":"text","text":"this documentation for Datadog"}],"type":"link","title":"this documentation for Datadog"},"https://developer.apple.com/documentation/xcode/environment-variable-reference#Variables-that-are-always-available":{"type":"link","url":"https:\/\/developer.apple.com\/documentation\/xcode\/environment-variable-reference#Variables-that-are-always-available","titleInlineContent":[{"type":"text","text":"Xcode Cloud environment variable documentation"}],"identifier":"https:\/\/developer.apple.com\/documentation\/xcode\/environment-variable-reference#Variables-that-are-always-available","title":"Xcode Cloud environment variable documentation"},"testPlanConfiguration":{"identifier":"testPlanConfiguration","variants":[{"url":"\/images\/testPlanConfiguration.png","traits":["1x","light"]}],"alt":"Screenshot of the TestPlan configuration. Values are set as described below.","type":"image"}}}