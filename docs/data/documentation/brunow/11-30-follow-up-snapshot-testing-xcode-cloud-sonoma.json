{"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/Brunow\/documentation\/Brunow\/11-30-follow-up-snapshot-testing-xcode-cloud-sonoma"},"kind":"article","schemaVersion":{"minor":3,"major":0,"patch":0},"metadata":{"title":"Follow up: Snapshot Testing with Xcode Cloud on Sonoma","platforms":[{"name":"Brunow","introducedAt":"2023.11.30"}],"color":{"standardColorIdentifier":"purple"},"modules":[{"name":"Brunow"}]},"topicSectionsStyle":"detailedGrid","abstract":[{"text":"Working around a change in simulator configuration.","type":"text"}],"sections":[],"hierarchy":{"paths":[["doc:\/\/Brunow\/documentation\/Brunow"],["doc:\/\/Brunow\/documentation\/Brunow","doc:\/\/Brunow\/documentation\/Brunow\/Archive","doc:\/\/Brunow\/documentation\/Brunow\/2023"]]},"primaryContentSections":[{"content":[{"type":"heading","text":"Backstory","anchor":"Backstory","level":2},{"inlineContent":[{"type":"text","text":"In my "},{"type":"reference","overridingTitle":"last blog post","overridingTitleInlineContent":[{"text":"last blog post","type":"text"}],"isActive":true,"identifier":"doc:\/\/Brunow\/documentation\/Brunow\/10-21-here-be-dragons-snapshot-testing-edition"},{"type":"text","text":" I"},{"text":" ","type":"text"},{"type":"text","text":"discussed an"},{"text":" ","type":"text"},{"overridingTitle":"issue I ran into when running snapshot tests on Xcode Cloud when the runners were using macOS Sonoma","overridingTitleInlineContent":[{"text":"issue I ran into when running snapshot tests on Xcode Cloud when the runners were using macOS Sonoma","type":"text"}],"identifier":"doc:\/\/Brunow\/documentation\/Brunow\/10-21-here-be-dragons-snapshot-testing-edition#macOS-Sonoma-Rendering-Differently-on-Xcode-Clouds-Intel-machines","isActive":true,"type":"reference"},{"text":":","type":"text"}],"type":"paragraph"},{"content":[{"type":"paragraph","inlineContent":[{"text":"OK [simulators on macOS Sonoma have] 34 preferred languages, cool.","type":"text"},{"type":"text","text":" "},{"type":"text","text":"Running this same test on macOS Ventura returns 1 preferred language."}]}],"name":"Quote from that blog post","style":"note","type":"aside"},{"type":"paragraph","inlineContent":[{"text":"As I described later in that post, those preferred languages include Arabic","type":"text"},{"text":" ","type":"text"},{"text":"which causes snapshots to be rendered differently than when Arabic is not in the","type":"text"},{"type":"text","text":" "},{"type":"text","text":"preferred languages."}]},{"type":"paragraph","inlineContent":[{"text":"My workaround at the time was to avoid using Sonoma but fortunately I‚Äôve now had","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"a chance to find a solution."}]},{"anchor":"Controlling-the-Xcode-Cloud-Simulator-Environment","level":2,"type":"heading","text":"Controlling the Xcode Cloud Simulator Environment"},{"inlineContent":[{"type":"text","text":"I had filed a Feedback with Apple for the issue while I was writing that"},{"text":" ","type":"text"},{"type":"text","text":"previous blog post. I shared that Feedback with an iOS developer community I‚Äôm a"},{"type":"text","text":" "},{"text":"part of and Francis Chary recommended that I use a pre-xcodebuild script to","type":"text"},{"type":"text","text":" "},{"text":"setup the  simulator the way I needed it to be setup. That recommendation led to","type":"text"},{"type":"text","text":" "},{"type":"text","text":"me create a "},{"code":"ci_pre_xcodebuild.sh","type":"codeVoice"},{"type":"text","text":" script which sets ‚Äúen‚Äù as the only language"},{"text":" ","type":"text"},{"text":"and ‚Äúen_US‚Äù as the only locale on all the simulators on the build machines used","type":"text"},{"type":"text","text":" "},{"text":"for testing (see ","type":"text"},{"identifier":"https:\/\/developer.apple.com\/documentation\/Xcode\/Writing-Custom-Build-Scripts","isActive":true,"type":"reference"},{"type":"text","text":" "},{"type":"text","text":"for more information about the scripts that Xcode Cloud supports). Here is the"},{"text":" ","type":"text"},{"text":"script (","type":"text"},{"identifier":"https:\/\/gist.github.com\/DavidBrunow\/3ef4a1fa3e61c09411270c7c181c3174","type":"reference","isActive":true},{"text":"):","type":"text"}],"type":"paragraph"},{"syntax":"shell","code":["#!\/bin\/sh","","if [[ $CI_XCODEBUILD_ACTION == \"test-without-building\" ]]","then","  # Setup the simulators so that they only have one preferred language.","  # This works around an issue where the simulators on Sonoma have multiple","  # preferred languages which include Arabic and therefore provide different","  # results when running snapshot tests.","  #","  # This solution was inspired by: https:\/\/stackoverflow.com\/a\/74335552","  brew install jq","  brew install parallel","","  # In my testing running more than 2 jobs in parallel led to flaky tests","  # where the simulators would error out.","  xcrun simctl list -j \"devices\" \\","    | jq -r '.devices | with_entries(select(.key | contains(\"iOS\"))) | map(.[] | select(.isAvailable == true)) | .[] .udid' \\","    | parallel --jobs 2 'echo {}; xcrun simctl boot {}; xcrun simctl spawn {} defaults write \"Apple Global Domain\" AppleLanguages -array en; xcrun simctl spawn {} defaults write \"Apple Global Domain\" AppleLocale -string en_US; xcrun simctl shutdown {};'","fi"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"This script fixes the issue and now all my tests pass on Xcode Cloud runners"},{"type":"text","text":" "},{"text":"using Sonoma. üéâ","type":"text"}],"type":"paragraph"}],"kind":"content"}],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/brunow\/11-30-follow-up-snapshot-testing-xcode-cloud-sonoma"]}],"references":{"misrenderedSwiftUIList.png":{"type":"image","identifier":"misrenderedSwiftUIList.png","variants":[{"url":"\/images\/misrenderedSwiftUIList@3x.png","traits":["3x","light"]}],"alt":"Screenshot of a user interface which was not rendered properly in snapshot tests."},"doc://Brunow/documentation/Brunow/10-21-here-be-dragons-snapshot-testing-edition":{"type":"topic","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/10-21-here-be-dragons-snapshot-testing-edition","abstract":[{"type":"text","text":"Stumbling over complexity and hiding it with opinions."}],"kind":"article","role":"article","title":"Here Be Dragons: iOS Snapshot Testing Edition","images":[{"type":"card","identifier":"misrenderedSwiftUIList.png"}],"url":"\/documentation\/brunow\/10-21-here-be-dragons-snapshot-testing-edition"},"doc://Brunow/documentation/Brunow/2023":{"type":"topic","title":"2023","role":"collectionGroup","url":"\/documentation\/brunow\/2023","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/2023","abstract":[],"kind":"article"},"doc://Brunow/documentation/Brunow/Archive":{"url":"\/documentation\/brunow\/archive","abstract":[{"text":"All posts","type":"text"}],"kind":"article","type":"topic","role":"collectionGroup","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/Archive","title":"Archive"},"doc://Brunow/documentation/Brunow":{"url":"\/documentation\/brunow","kind":"symbol","identifier":"doc:\/\/Brunow\/documentation\/Brunow","type":"topic","abstract":[{"text":"David Brunow, known as Brunow [Ààb…πuno ä] to the folks he works with, is a human living on Earth. You might have something in common with him ‚Äî if you think it is ridiculous that he is talking about himself in the first person here, so does he.","type":"text"}],"role":"collection","title":"Brunow"},"doc://Brunow/documentation/Brunow/10-21-here-be-dragons-snapshot-testing-edition#macOS-Sonoma-Rendering-Differently-on-Xcode-Clouds-Intel-machines":{"type":"topic","title":"macOS Sonoma Rendering Differently on Xcode Cloud‚Äôs Intel machines","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/10-21-here-be-dragons-snapshot-testing-edition#macOS-Sonoma-Rendering-Differently-on-Xcode-Clouds-Intel-machines","kind":"section","url":"\/documentation\/brunow\/10-21-here-be-dragons-snapshot-testing-edition#macOS-Sonoma-Rendering-Differently-on-Xcode-Clouds-Intel-machines","abstract":[]},"https://gist.github.com/DavidBrunow/3ef4a1fa3e61c09411270c7c181c3174":{"titleInlineContent":[{"text":"gist","type":"text"}],"title":"gist","type":"link","identifier":"https:\/\/gist.github.com\/DavidBrunow\/3ef4a1fa3e61c09411270c7c181c3174","url":"https:\/\/gist.github.com\/DavidBrunow\/3ef4a1fa3e61c09411270c7c181c3174"},"https://developer.apple.com/documentation/Xcode/Writing-Custom-Build-Scripts":{"type":"link","title":"this documentation","identifier":"https:\/\/developer.apple.com\/documentation\/Xcode\/Writing-Custom-Build-Scripts","url":"https:\/\/developer.apple.com\/documentation\/Xcode\/Writing-Custom-Build-Scripts","titleInlineContent":[{"text":"this documentation","type":"text"}]}}}