{"abstract":[{"type":"text","text":"Storing CI tools in a centralized location to be used across the pipelines for"},{"type":"text","text":" "},{"text":"multiple projects.","type":"text"}],"kind":"article","variants":[{"paths":["\/documentation\/brunow\/04-21-ci-tooling"],"traits":[{"interfaceLanguage":"swift"}]}],"schemaVersion":{"patch":0,"minor":3,"major":0},"hierarchy":{"paths":[["doc:\/\/Brunow\/documentation\/Brunow"],["doc:\/\/Brunow\/documentation\/Brunow","doc:\/\/Brunow\/documentation\/Brunow\/Archive","doc:\/\/Brunow\/documentation\/Brunow\/2024"]]},"metadata":{"images":[{"identifier":"allChecksHavePassed.png","type":"card"}],"modules":[{"name":"Brunow"}],"title":"CI Tooling","platforms":[{"introducedAt":"2024.04.21","name":"Brunow"}],"color":{"standardColorIdentifier":"purple"}},"primaryContentSections":[{"content":[{"level":2,"anchor":"Overview","type":"heading","text":"Overview"},{"type":"paragraph","inlineContent":[{"type":"text","text":"When I was working at American Airlines, I took charge of the CI architecture"},{"text":" ","type":"text"},{"text":"for Apple platforms. The CI supported the main American Airlines customer-facing","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"app, which was modularized with each module living in its own repo. This meant"},{"type":"text","text":" "},{"type":"text","text":"that we needed our CI architecture to support many repos. Since CI architecture"},{"type":"text","text":" "},{"type":"text","text":"wasn’t my primary responsibility (I was a senior iOS developer on a platform"},{"text":" ","type":"text"},{"type":"text","text":"team), I also needed the system to be easily maintained from as few places as"},{"text":" ","type":"text"},{"type":"text","text":"possible – I really did not want to update every module repo every time we"},{"text":" ","type":"text"},{"type":"text","text":"wanted to add new functionality to our CI pipelines."}]},{"type":"paragraph","inlineContent":[{"text":"My solution was to have the bare minimum of CI infrastructure in the repos and","type":"text"},{"type":"text","text":" "},{"type":"text","text":"have everything else living in a separate repo which could be cloned during the"},{"type":"text","text":" "},{"text":"CI job. When I first implemented this at American Airlines we were using GitHub","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"Enterprise for our source control platform and Jenkins for CI, so that meant"},{"text":" ","type":"text"},{"text":"that every repo had a Jenkinsfile but nothing else related to CI. When I","type":"text"},{"type":"text","text":" "},{"type":"text","text":"migrated the team from GitHub Enterprise to the hosted GitHub and switched CI to"},{"type":"text","text":" "},{"text":"GitHub Actions, every repo had a yaml file defining their actions but nothing","type":"text"},{"type":"text","text":" "},{"type":"text","text":"else related to CI. In both of these situations, updating the Jenkinsfiles or"},{"type":"text","text":" "},{"type":"text","text":"GitHub Actions yaml files across modules was painful, but it was also rare."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"When I started working at Hilton, they already had a similar app architecture"},{"type":"text","text":" "},{"type":"text","text":"that was modularized with each module in a separate repo. At that time, we were"},{"type":"text","text":" "},{"text":"using a hosted BitBucket instance for our source control platform and Jenkins","type":"text"},{"text":" ","type":"text"},{"text":"for CI so I implemented a similar pattern to what I had at American Airlines –","type":"text"},{"type":"text","text":" "},{"text":"each repo only had a Jenkinsfile in it and all the tools were hosted in a","type":"text"},{"type":"text","text":" "},{"type":"text","text":"separate repo. Then when I migrated the team to a hosted GitLab instance, I was"},{"text":" ","type":"text"},{"type":"text","text":"able to build things in such a way that each repo had no references to CI in the"},{"text":" ","type":"text"},{"type":"text","text":"codebase – instead, the settings for each repo point to a centralized"},{"type":"text","text":" "},{"type":"text","text":"configuration file in that same separate repo that holds the rest of the CI"},{"text":" ","type":"text"},{"text":"tooling.","type":"text"}]},{"inlineContent":[{"text":"The current state of our CI architecture is working really well for us, so in","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"this post I’d like to share one bit that I think is critical – this separate"},{"type":"text","text":" "},{"type":"text","text":"repo of CI tooling that provides everything a repo needs to run its CI jobs."}],"type":"paragraph"},{"text":"The CI Tooling Repository","type":"heading","anchor":"The-CI-Tooling-Repository","level":2},{"type":"heading","text":"What It Is","level":3,"anchor":"What-It-Is"},{"type":"paragraph","inlineContent":[{"text":"The CI Tooling repository is simply another repo that holds all the tools needed","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"for CI, with only two things that make it work differently from other repos:"}]},{"items":[{"content":[{"inlineContent":[{"text":"The repository does not use the main branch, instead it uses a branch per","type":"text"},{"text":" ","type":"text"},{"text":"supported platform","type":"text"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The repository knows how to “unpack” itself so that its contents get put in"},{"type":"text","text":" "},{"type":"text","text":"the right places"}]}]}],"type":"unorderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Let’s talk through each of those in more detail."}]},{"type":"heading","anchor":"Branch-per-Supported-Platform","text":"Branch per Supported Platform","level":4},{"inlineContent":[{"text":"When I say “supported platform” here, I mean the type of thing being built. For","type":"text"},{"text":" ","type":"text"},{"text":"example, at Hilton the CI infrastructure I’ve built supports both our Android","type":"text"},{"type":"text","text":" "},{"type":"text","text":"app and our apps for Apple platforms (iOS, watchOS, and macOS command line"},{"text":" ","type":"text"},{"type":"text","text":"tools). Therefore, our CI Tooling repo has two primary branches, "},{"type":"codeVoice","code":"apple"},{"text":" for","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"Apple platforms, and "},{"code":"android","type":"codeVoice"},{"text":" for the Android app.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"When we want to make improvements to our Apple CI, we create a branch off of our"},{"text":" ","type":"text"},{"code":"apple","type":"codeVoice"},{"text":" branch, do the work, and create a merge request back into the ","type":"text"},{"type":"codeVoice","code":"apple"},{"text":" ","type":"text"},{"text":"branch. This does mean some duplicated work at times – some things we do on CI","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"are common across platforms, like tagging releases – but my current stance is"},{"text":" ","type":"text"},{"type":"text","text":"that that duplicated work is less effort and less error-prone than putting all"},{"type":"text","text":" "},{"text":"our tooling together onto one branch. We’re also looking into ways to abstract","type":"text"},{"type":"text","text":" "},{"text":"out some of that duplicated work.","type":"text"}],"type":"paragraph"},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"In reality, our naming at Hilton is not quite this simple at the moment"},{"text":" ","type":"text"},{"text":"because I thought it would be useful to have more specific branch naming. The","type":"text"},{"type":"text","text":" "},{"text":"branch name we use for Apple platforms is currently","type":"text"},{"text":" ","type":"text"},{"code":"apple\/xcode14-dangerSwiftLint-dangerSwiftFormat","type":"codeVoice"},{"type":"text","text":" – I thought that including"},{"type":"text","text":" "},{"type":"text","text":"the capabilities enabled by the branch in the branch name would be useful but"},{"type":"text","text":" "},{"type":"text","text":"it simply made things more complicated while providing no benefit."}]},{"inlineContent":[{"text":"We’ll be moving to simpler names in the near future which is why I feel OK","type":"text"},{"text":" ","type":"text"},{"text":"putting this in a note rather than inline above.","type":"text"}],"type":"paragraph"}],"style":"note","name":"Note","type":"aside"},{"level":4,"anchor":"Unpacking-the-CI-Tooling","type":"heading","text":"Unpacking the CI Tooling"},{"type":"paragraph","inlineContent":[{"text":"For maximum flexibility, it is really useful for the CI tooling repo to know how","type":"text"},{"type":"text","text":" "},{"type":"text","text":"to put its tools in the right place. One example is the Dangerfile – it must be"},{"text":" ","type":"text"},{"type":"text","text":"in the root of the repo on which you want to run Danger. But maintaining a"},{"text":" ","type":"text"},{"type":"text","text":"separate Dangerfile in every repo when you have tens of repos is unwieldy. It is"},{"text":" ","type":"text"},{"type":"text","text":"much simpler to have a single Dangerfile in the CI tooling repo which can then"},{"text":" ","type":"text"},{"text":"be placed in the right place when unpacked. And it is much more flexible for the","type":"text"},{"type":"text","text":" "},{"type":"text","text":"CI Tooling repo to own that unpacking so that its contents can be re-organized,"},{"type":"text","text":" "},{"text":"or new contents can be added, without anything outside the repo needing to be","type":"text"},{"type":"text","text":" "},{"text":"changed.","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"To do that, the CI tooling repo needs a script which I like to call ","type":"text"},{"type":"codeVoice","code":"unpack.sh"},{"type":"text","text":"."},{"type":"text","text":" "},{"type":"text","text":"This script does two main things:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Deletes the .git folder from the checked-out CI tooling repo so any git"},{"text":" ","type":"text"},{"type":"text","text":"operations will be performed on the repo where the CI job is being run, and"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Puts files where they are needed for CI to function properly"}],"type":"paragraph"}]}],"type":"orderedList"},{"type":"paragraph","inlineContent":[{"type":"text","text":"An "},{"code":"unpack.sh","type":"codeVoice"},{"type":"text","text":" that moves a Dangerfile.swift to the right place could look like"},{"type":"text","text":" "},{"text":"this:","type":"text"}]},{"type":"codeListing","code":["#! \/bin\/sh","","rm -rf $(dirname \"$0\")\/.git","","# Move things out of the CI-Tooling repo here","mv $(dirname \"$0\")\/Dangerfile.swift $(dirname \"$0\")\/.."],"syntax":"shell"},{"text":"What Tools We Keep In It","type":"heading","anchor":"What-Tools-We-Keep-In-It","level":3},{"type":"paragraph","inlineContent":[{"type":"text","text":"These are the kinds of tools I like to keep in the CI Tooling repo:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Danger Swift pre-built binaries, both executable and library","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Dangerfile","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Pre-built Swift tool to parse formatted commits"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Pre-built swiftlint binary"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Pre-built Swift tool to show public API diffs","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Fastlane files (Fastfile and Matchfile)","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Any other pre-built binaries or tools that are only used on CI"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":3,"text":"What We Do Not Keep In It","type":"heading","anchor":"What-We-Do-Not-Keep-In-It"},{"inlineContent":[{"type":"text","text":"There are some things that we want in common across all our modules that we do"},{"text":" ","type":"text"},{"type":"text","text":"not keep in CI Tooling. The determinant for this is whether developers need to"},{"type":"text","text":" "},{"type":"text","text":"use those things locally as well, such as configuration files for SwiftLint and"},{"text":" ","type":"text"},{"text":"Swift Format. We want our developers to get warnings and errors from those tools","type":"text"},{"type":"text","text":" "},{"type":"text","text":"early, in their IDE, so we need those configurations inside the module repos"},{"text":" ","type":"text"},{"type":"text","text":"rather than being in CI Tooling."}],"type":"paragraph"},{"anchor":"How-to-Use-It","level":3,"type":"heading","text":"How to Use It"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Using this repo is fairly simple – clone the repo with a depth of 1 to only"},{"type":"text","text":" "},{"text":"clone the last commit, run the ","type":"text"},{"code":"unpack.sh","type":"codeVoice"},{"type":"text","text":" script, and then use the tools within"},{"text":" ","type":"text"},{"type":"text","text":"the repo as you would in any other script. For example:"}]},{"type":"codeListing","syntax":"shell","code":["...","git clone https:\/\/www.github.com\/DavidBrunow\/CI-Tooling.git --depth 1",".\/CI-Tooling\/unpack.sh","fastlane run_tests","..."]},{"anchor":"Keys-to-Success","text":"Keys to Success","type":"heading","level":3},{"type":"paragraph","inlineContent":[{"type":"text","text":"The biggest key to success is ensuring that you have consistency across your"},{"text":" ","type":"text"},{"text":"different repos. This means having a standard folder structure, standard tools","type":"text"},{"type":"text","text":" "},{"text":"used, code quality standards, and one module per repo. A bonus side effect of","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"this approach is that humans love consistency as well – it will be easier for"},{"type":"text","text":" "},{"type":"text","text":"your team to work within consistent repos than it would be if every repo follows"},{"text":" ","type":"text"},{"type":"text","text":"its own rules."}]},{"type":"paragraph","inlineContent":[{"text":"But also, you will always have exceptions.","type":"text"}]},{"inlineContent":[{"type":"text","text":"Sometimes it makes sense to special case those exceptions in your tooling. For"},{"text":" ","type":"text"},{"type":"text","text":"example, we have some legacy repos that we don’t want to use "},{"code":"swift-format","type":"codeVoice"},{"type":"text","text":" on"},{"type":"text","text":" "},{"text":"because it would cause a massive amount of churn and we don’t see the value in","type":"text"},{"text":" ","type":"text"},{"text":"that churn with the legacy code. We have chosen to special case those repos by","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"testing for the existence of a "},{"code":".swift-format","type":"codeVoice"},{"text":" configuration file in the","type":"text"},{"type":"text","text":" "},{"type":"text","text":"repo. When possible, I like to use something specific to the tool being used to"},{"type":"text","text":" "},{"type":"text","text":"function like a feature flag. For other situations, we’ve had to special case by"},{"text":" ","type":"text"},{"text":"individual module names, which I only do if there is no other way to solve the","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"problem."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Sometimes it makes sense to have entirely different tooling for different"},{"type":"text","text":" "},{"type":"text","text":"contexts. For example, we have different CI pipeline definitions for modules vs."},{"type":"text","text":" "},{"text":"the main app – there are enough differences between the two that it is easier to","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"maintain two different files, each with a clear focus, than to try to put"},{"type":"text","text":" "},{"text":"everything into a single file.","type":"text"}]},{"level":3,"text":"Example","anchor":"Example","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"I’ve setup an example of my CI Tooling pattern in the repo for a","type":"text"},{"text":" ","type":"text"},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/DavidBrunow\/swift-conventional-commit-parser"},{"text":".","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You can see the “client” side in the "},{"type":"reference","identifier":"https:\/\/github.com\/DavidBrunow\/swift-conventional-commit-parser\/blob\/main\/.github\/workflows\/pull_request.yml","isActive":true},{"type":"text","text":". It is simple enough that I can just"},{"text":" ","type":"text"},{"text":"copy it here:","type":"text"}]},{"syntax":"yml","code":["on:","  pull_request:","","jobs:","  ci_tooling:","    uses: DavidBrunow\/CI-Tooling\/.github\/workflows\/macos-tools-pull-request-action.yml@apple","    permissions:","      pull-requests: write"],"type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Lines 1 and 2 say that this action should be run on pull requests. Line 6 says"},{"text":" ","type":"text"},{"text":"that this pipeline should use the shared pipeline in my CI-Tooling repo, using","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"the configuration in "},{"type":"codeVoice","code":".github\/workflows\/macos-tools-pull-request-action.yml"},{"type":"text","text":" on"},{"text":" ","type":"text"},{"type":"text","text":"the branch "},{"type":"codeVoice","code":"apple"},{"text":". Lines 7 and 8 give the shared pipeline permission to add","type":"text"},{"type":"text","text":" "},{"type":"text","text":"comments to the pull request, which is needed for Danger Swift to add its"},{"type":"text","text":" "},{"type":"text","text":"feedback."}]},{"type":"paragraph","inlineContent":[{"text":"You can see the shared CI Tooling side for that action in","type":"text"},{"text":" ","type":"text"},{"identifier":"https:\/\/github.com\/DavidBrunow\/CI-Tooling\/blob\/apple\/.github\/workflows\/macos-tools-pull-request-action.yml","isActive":true,"type":"reference"},{"type":"text","text":". This file is more"},{"type":"text","text":" "},{"type":"text","text":"complex because it is doing all the work – the client’s file is only calling"},{"type":"text","text":" "},{"type":"text","text":"into this one. I’m not going to go through it line by line because most of it is"},{"type":"text","text":" "},{"type":"text","text":"specific to what I want to do on CI and might be a good starting point for you,"},{"type":"text","text":" "},{"type":"text","text":"but you also may already have all those bits figured out. But line 31 is"},{"type":"text","text":" "},{"text":"important:","type":"text"}]},{"code":["export SCHEME=`xcodebuild -list -json | jq -r '.workspace.schemes[0]'`"],"type":"codeListing","syntax":"shell"},{"inlineContent":[{"text":"The script in the CI Tooling repo is generic and does not know what project it","type":"text"},{"type":"text","text":" "},{"type":"text","text":"is working on. Therefore it needs to figure out what scheme to use for running"},{"text":" ","type":"text"},{"text":"tests, which it gets from the ","type":"text"},{"type":"codeVoice","code":"xcodebuild -list -json"},{"type":"text","text":" command. Making this"},{"type":"text","text":" "},{"type":"text","text":"tooling generic means that it cannot make assumptions. This makes things more"},{"type":"text","text":" "},{"type":"text","text":"difficult to initially get setup but makes adding new clients simple and"},{"text":" ","type":"text"},{"type":"text","text":"straightforward."}],"type":"paragraph"},{"type":"aside","content":[{"inlineContent":[{"type":"text","text":"Do not use my CI Tooling repo – always have your own that is"},{"type":"text","text":" "},{"text":"completely under your control! If you use my repo then I have too much access","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"to your CI pipelines and, theoretically, could do bad things. I wouldn’t do"},{"type":"text","text":" "},{"type":"text","text":"that because I’m a nice person, but you still shouldn’t trust me."}],"type":"paragraph"}],"style":"warning","name":"Warning"},{"name":"Note","style":"note","type":"aside","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"When using these shared configuration files on both GitHub and GitLab, a"},{"type":"text","text":" "},{"text":"new pull request must be opened to get the latest version of the shared","type":"text"},{"type":"text","text":" "},{"text":"configuration file. Both platforms cache the configuration file when the pull","type":"text"},{"text":" ","type":"text"},{"text":"request is opened.","type":"text"}]}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"You can also poke around that repo and see the other shared CI tools that I"},{"type":"text","text":" "},{"type":"text","text":"have, some of which I plan to talk more about in future blog posts."}]}],"kind":"content"}],"sections":[],"identifier":{"url":"doc:\/\/Brunow\/documentation\/Brunow\/04-21-ci-tooling","interfaceLanguage":"swift"},"topicSectionsStyle":"detailedGrid","references":{"doc://Brunow/documentation/Brunow":{"url":"\/documentation\/brunow","title":"Brunow","kind":"symbol","type":"topic","role":"collection","identifier":"doc:\/\/Brunow\/documentation\/Brunow","abstract":[{"type":"text","text":"David Brunow, known as Brunow [ˈbɹunoʊ] to the folks he works with, is a human living on Earth. You might have something in common with him — if you think it is ridiculous that he is talking about himself in the first person here, so does he."}]},"allChecksHavePassed.png":{"alt":null,"type":"image","identifier":"allChecksHavePassed.png","variants":[{"traits":["1x","light"],"url":"\/images\/allChecksHavePassed@1x.png"}]},"https://github.com/DavidBrunow/CI-Tooling/blob/apple/.github/workflows/macos-tools-pull-request-action.yml":{"titleInlineContent":[{"text":"this configuration file","type":"text"}],"type":"link","identifier":"https:\/\/github.com\/DavidBrunow\/CI-Tooling\/blob\/apple\/.github\/workflows\/macos-tools-pull-request-action.yml","title":"this configuration file","url":"https:\/\/github.com\/DavidBrunow\/CI-Tooling\/blob\/apple\/.github\/workflows\/macos-tools-pull-request-action.yml"},"https://github.com/DavidBrunow/swift-conventional-commit-parser/blob/main/.github/workflows/pull_request.yml":{"title":"pull request GitHub action","titleInlineContent":[{"text":"pull request GitHub action","type":"text"}],"type":"link","identifier":"https:\/\/github.com\/DavidBrunow\/swift-conventional-commit-parser\/blob\/main\/.github\/workflows\/pull_request.yml","url":"https:\/\/github.com\/DavidBrunow\/swift-conventional-commit-parser\/blob\/main\/.github\/workflows\/pull_request.yml"},"https://github.com/DavidBrunow/swift-conventional-commit-parser":{"titleInlineContent":[{"text":"macOS command line tool that parses conventional commits","type":"text"}],"type":"link","identifier":"https:\/\/github.com\/DavidBrunow\/swift-conventional-commit-parser","title":"macOS command line tool that parses conventional commits","url":"https:\/\/github.com\/DavidBrunow\/swift-conventional-commit-parser"},"doc://Brunow/documentation/Brunow/2024":{"title":"2024","url":"\/documentation\/brunow\/2024","kind":"article","type":"topic","role":"collectionGroup","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/2024","abstract":[]},"doc://Brunow/documentation/Brunow/Archive":{"kind":"article","role":"collectionGroup","abstract":[{"text":"All posts","type":"text"}],"url":"\/documentation\/brunow\/archive","type":"topic","title":"Archive","identifier":"doc:\/\/Brunow\/documentation\/Brunow\/Archive"}}}